{% extends "_base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ meeting.title }} - {% trans "Meeting Details" %}{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="mb-0"><i class="bi bi-calendar-event"></i> {{ meeting.title }}</h1>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'group:meeting-edit' meeting.pk %}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> {% trans "Edit" %}
                    </a>
                    <a href="{% url 'group:group-detail' meeting.group.pk %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> {% trans "Back to Group" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% trans "Meeting Information" %}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">{% trans "Title" %}</dt>
                                <dd class="col-sm-8">{{ meeting.title }}</dd>
                                
                                <dt class="col-sm-4">{% trans "Group" %}</dt>
                                <dd class="col-sm-8">
                                    <a href="{% url 'group:group-detail' meeting.group.pk %}">{{ meeting.group.name }}</a>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">{% trans "Date & Time" %}</dt>
                                <dd class="col-sm-8">
                                    {{ meeting.scheduled_date|date:"M d, Y H:i" }}
                                    {% if meeting.is_upcoming %}
                                        <br><small class="text-success">{% trans "In" %} {{ meeting.time_until_meeting }}</small>
                                    {% else %}
                                        <br><small class="text-muted">{% trans "Past meeting" %}</small>
                                    {% endif %}
                                </dd>
                                
                                {% if meeting.location %}
                                <dt class="col-sm-4">{% trans "Location" %}</dt>
                                <dd class="col-sm-8">{{ meeting.location }}</dd>
                                {% endif %}
                                
                                <dt class="col-sm-4">{% trans "Status" %}</dt>
                                <dd class="col-sm-8">
                                    {% if meeting.status == 'scheduled' %}
                                        <span class="badge bg-primary">{% trans "Scheduled" %}</span>
                                    {% elif meeting.status == 'invited' %}
                                        <span class="badge bg-info">{% trans "Invited" %}</span>
                                    {% elif meeting.status == 'cancelled' %}
                                        <span class="badge bg-danger">{% trans "Cancelled" %}</span>
                                    {% endif %}
                                    {% if meeting.is_past and meeting.status != 'cancelled' %}
                                        <span class="badge bg-secondary ms-1">{% trans "Past" %}</span>
                                    {% elif not meeting.is_past and meeting.status != 'cancelled' %}
                                        <span class="badge bg-success ms-1">{% trans "Upcoming" %}</span>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                    </div>
                    {% if meeting.status != 'cancelled' %}
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex flex-wrap gap-2">
                                {% if meeting.status == 'scheduled' and can_send_invites and not meeting.is_past %}
                                    <form method="post" action="{% url 'group:meeting-send-invites' meeting.pk %}" style="margin: 0;" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('{% trans "Send meeting invites to all group members?" %}');">
                                            <i class="bi bi-envelope"></i> {% trans "Send Invites" %}
                                        </button>
                                    </form>
                                {% endif %}
                                {% if meeting.status == 'invited' %}
                                    <a href="{% url 'group:meeting-cancel' meeting.pk %}" class="btn btn-warning btn-sm">
                                        <i class="bi bi-x-circle"></i> {% trans "Cancel meeting" %}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if meeting.description %}
                        <hr>
                        <h6>{% trans "Description" %}</h6>
                        <p>{{ meeting.description|linebreaks }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Agenda Section -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> {% trans "Agenda" %}</h5>
                    {% if meeting.status == 'scheduled' %}
                    <div>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAgendaItemModal">
                            <i class="bi bi-plus-circle"></i> {% trans "Add" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="agenda-list" class="sortable-list">
                        {% if agenda_items %}
                            {% for item in agenda_items %}
                                <div class="agenda-item" data-item-id="{{ item.pk }}" data-order="{{ item.order }}" data-parent="{{ item.parent_item.pk|default:'' }}" draggable="true">
                                    <div class="card mb-2 agenda-item-card agenda-level-{{ item.level }}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ item.title }}</h6>
                                                    {% if item.description %}
                                                        <p class="text-muted small mb-0">{{ item.description }}</p>
                                                    {% endif %}
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editAgendaItem({{ item.pk }})">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteAgendaItem({{ item.pk }})">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-list-ul fs-1 text-muted"></i>
                                <h6 class="mt-3">{% trans "No agenda items" %}</h6>
                                <p class="text-muted">{% trans "Add agenda items to organize the meeting topics." %}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% trans "Actions" %}</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'group:meeting-export-ics' meeting.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-calendar-plus"></i> {% trans "Download Calendar" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Agenda Item Modal -->
<div class="modal fade" id="addAgendaItemModal" tabindex="-1" aria-labelledby="addAgendaItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAgendaItemModalLabel">{% trans "Add Agenda Item" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addAgendaItemForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="agenda_title" class="form-label">{% trans "Title" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="agenda_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="agenda_description" class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="agenda_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="agenda_parent" class="form-label">{% trans "Parent Item" %}</label>
                        <select class="form-select" id="agenda_parent" name="parent_item">
                            <option value="">{% trans "No parent (top level)" %}</option>
                            {% for item in agenda_items %}
                                <option value="{{ item.pk }}">{{ item.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="agenda_order" class="form-label">{% trans "Order" %} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="agenda_order" name="order" min="1" required>
                        <div class="form-text">{% trans "Order of the agenda item (1, 2, 3, etc.)" %}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Add Item" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Agenda Item Modal -->
<div class="modal fade" id="editAgendaItemModal" tabindex="-1" aria-labelledby="editAgendaItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAgendaItemModalLabel">{% trans "Edit Agenda Item" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editAgendaItemForm">
                {% csrf_token %}
                <input type="hidden" id="edit_agenda_id" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_agenda_title" class="form-label">{% trans "Title" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_agenda_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_agenda_description" class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="edit_agenda_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_agenda_parent" class="form-label">{% trans "Parent Item" %}</label>
                        <select class="form-select" id="edit_agenda_parent" name="parent_item">
                            <option value="">{% trans "No parent (top level)" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_agenda_order" class="form-label">{% trans "Order" %} <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="edit_agenda_order" name="order" min="1" required>
                        <div class="form-text">{% trans "Order of the agenda item (1, 2, 3, etc.)" %}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Update Item" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// AJAX functionality for agenda management
document.addEventListener('DOMContentLoaded', function() {
    // Auto-set order when modal opens
    document.getElementById('addAgendaItemModal').addEventListener('show.bs.modal', function() {
        // Get the next available order number
        const existingItems = document.querySelectorAll('.agenda-item');
        const nextOrder = existingItems.length + 1;
        document.getElementById('agenda_order').value = nextOrder;
    });
    
    // Populate parent items dropdown when edit modal opens
    document.getElementById('editAgendaItemModal').addEventListener('show.bs.modal', function() {
        const parentSelect = document.getElementById('edit_agenda_parent');
        const currentItemId = document.getElementById('edit_agenda_id').value;
        
        // Clear existing options except the first one
        parentSelect.innerHTML = '<option value="">{% trans "No parent (top level)" %}</option>';
        
        // Add all agenda items except the current one being edited
        const agendaItems = document.querySelectorAll('.agenda-item');
        agendaItems.forEach(item => {
            if (item.dataset.itemId !== currentItemId) {
                const title = item.querySelector('h6').textContent;
                const option = document.createElement('option');
                option.value = item.dataset.itemId;
                option.textContent = title;
                parentSelect.appendChild(option);
            }
        });
    });
    
    // Add agenda item form submission
    document.getElementById('addAgendaItemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "group:agenda-item-create-ajax" meeting.pk %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('AJAX Response:', data);
            if (data.success) {
                location.reload(); // Reload to show new item
            } else {
                // Show detailed error information
                let errorMessage = 'Error: ' + (data.error || 'Unknown error');
                if (data.debug) {
                    errorMessage += '\n\nDebug Information:\n';
                    errorMessage += JSON.stringify(data.debug, null, 2);
                }
                if (data.errors) {
                    errorMessage += '\n\nForm Errors:\n';
                    errorMessage += JSON.stringify(data.errors, null, 2);
                }
                console.error('AJAX Error:', data);
                alert(errorMessage);
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            alert('Network error occurred while adding the agenda item. Check console for details.');
        });
    });
    
    // Edit agenda item form submission
    document.getElementById('editAgendaItemForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const agendaItemId = document.getElementById('edit_agenda_id').value;
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`{% url "group:agenda-item-update-ajax" 0 %}`.replace('0', agendaItemId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('AJAX Update Response:', data);
            if (data.success) {
                location.reload(); // Reload to show updated item
            } else {
                // Show detailed error information
                let errorMessage = 'Error: ' + (data.error || 'Unknown error');
                if (data.debug) {
                    errorMessage += '\n\nDebug Information:\n';
                    errorMessage += JSON.stringify(data.debug, null, 2);
                }
                if (data.errors) {
                    errorMessage += '\n\nForm Errors:\n';
                    errorMessage += JSON.stringify(data.errors, null, 2);
                }
                console.error('AJAX Update Error:', data);
                alert(errorMessage);
            }
        })
        .catch(error => {
            console.error('Network Error:', error);
            alert('Network error occurred while updating the agenda item. Check console for details.');
        });
    });
    
    // Make agenda items sortable
    const agendaList = document.getElementById('agenda-list');
    if (agendaList) {
        // Simple drag and drop implementation
        let draggedElement = null;
        
        agendaList.addEventListener('dragstart', function(e) {
            draggedElement = e.target.closest('.agenda-item');
            e.target.style.opacity = '0.5';
        });
        
        agendaList.addEventListener('dragend', function(e) {
            e.target.style.opacity = '';
            draggedElement = null;
        });
        
        agendaList.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        agendaList.addEventListener('drop', function(e) {
            e.preventDefault();
            if (draggedElement) {
                const afterElement = getDragAfterElement(agendaList, e.clientY);
                if (afterElement == null) {
                    agendaList.appendChild(draggedElement);
                } else {
                    agendaList.insertBefore(draggedElement, afterElement);
                }
                updateAgendaOrder();
            }
        });
    }
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.agenda-item:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateAgendaOrder() {
    const items = document.querySelectorAll('.agenda-item');
    const itemOrders = [];
    
    items.forEach((item, index) => {
        itemOrders.push({
            id: item.dataset.itemId,
            order: index + 1,
            parent_item: item.dataset.parent || null
        });
    });
    
    fetch('{% url "group:agenda-item-update-order" meeting.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            item_orders: itemOrders
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error updating order:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function editAgendaItem(itemId) {
    // Find the agenda item data from the DOM
    const agendaItem = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!agendaItem) {
        alert('Agenda item not found');
        return;
    }
    
    // Extract data from the agenda item
    const title = agendaItem.querySelector('h6').textContent;
    const description = agendaItem.querySelector('p.text-muted')?.textContent || '';
    const order = agendaItem.dataset.order;
    const parent = agendaItem.dataset.parent;
    
    // Populate the edit form
    document.getElementById('edit_agenda_id').value = itemId;
    document.getElementById('edit_agenda_title').value = title;
    document.getElementById('edit_agenda_description').value = description;
    document.getElementById('edit_agenda_order').value = order;
    document.getElementById('edit_agenda_parent').value = parent || '';
    
    // Show the edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editAgendaItemModal'));
    editModal.show();
}

function deleteAgendaItem(itemId) {
    if (confirm('{% trans "Are you sure you want to delete this agenda item?" %}')) {
        window.location.href = '{% url "group:agenda-item-delete" 0 %}'.replace('0', itemId);
    }
}
</script>

<style>
.agenda-item {
    cursor: move;
}

.agenda-item-card {
    border-left: 3px solid #007bff;
}

.sortable-list {
    min-height: 50px;
}

.agenda-item:hover {
    background-color: #f8f9fa;
}

/* Agenda level indentation */
.agenda-level-0 { margin-left: 0px; }
.agenda-level-1 { margin-left: 20px; }
.agenda-level-2 { margin-left: 40px; }
.agenda-level-3 { margin-left: 60px; }
.agenda-level-4 { margin-left: 80px; }
.agenda-level-5 { margin-left: 100px; }
.agenda-level-6 { margin-left: 120px; }
.agenda-level-7 { margin-left: 140px; }
.agenda-level-8 { margin-left: 160px; }
.agenda-level-9 { margin-left: 180px; }

</style>
{% endblock content %}
