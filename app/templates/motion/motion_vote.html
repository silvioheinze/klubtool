{% extends "_base.html" %}
{% load i18n %}

{% block title %}
    {% trans "Record Party Votes" %} - {{ motion.title }}
{% endblock title %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-check2-square"></i> {% trans "Record Party Votes" %}
            </h1>
            <p class="text-muted">{{ motion.title }}</p>
        </div>
        <div>
            <a href="{% url 'motion:motion-detail' motion.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> {% trans "Back to Motion" %}
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% trans "Party Voting Results" %}</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ formset.management_form }}
                        
                        {% if formset.non_form_errors %}
                            <div class="alert alert-danger">
                                {% for error in formset.non_form_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 25%; text-align: center;">{% trans "Party" %}</th>
                                        <th style="width: 15%; text-align: center;">{% trans "Approve" %}</th>
                                        <th style="width: 15%; text-align: center;">{% trans "Reject" %}</th>
                                        <th style="width: 15%; text-align: center;">{% trans "Abstain" %}</th>
                                        <th style="width: 10%; text-align: center;">{% trans "Total" %}</th>
                                        <th style="width: 20%; text-align: center;">{% trans "Notes" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for form in formset %}
                                        <tr>
                                            <td class="align-middle">
                                                {{ form.party }}
                                                <div class="fw-bold text-primary">
                                                    {% if form.party.value %}
                                                        {% for party in form.party.field.queryset %}
                                                            {% if party.pk == form.party.value %}
                                                                {{ party.name }}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        {% trans "Party" %}
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                {{ form.approve_votes }}
                                                {% if form.approve_votes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.approve_votes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {{ form.reject_votes }}
                                                {% if form.reject_votes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.reject_votes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {{ form.abstain_votes }}
                                                {% if form.abstain_votes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.abstain_votes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <div class="form-control-plaintext text-center fw-bold" id="total-{{ forloop.counter0 }}">
                                                    0
                                                </div>
                                            </td>
                                            <td>
                                                {{ form.notes }}
                                                {% if form.notes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.notes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {% trans "Record All Votes" %}
                            </button>
                            <a href="{% url 'motion:motion-detail' motion.pk %}" class="btn btn-outline-secondary">
                                {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                    
                    <script>
                        // Calculate totals for each party
                        document.addEventListener('DOMContentLoaded', function() {
                            const approveInputs = document.querySelectorAll('input[name*="approve_votes"]');
                            const rejectInputs = document.querySelectorAll('input[name*="reject_votes"]');
                            const abstainInputs = document.querySelectorAll('input[name*="abstain_votes"]');
                            
                            function updateTotal(index) {
                                const approve = parseInt(approveInputs[index].value) || 0;
                                const reject = parseInt(rejectInputs[index].value) || 0;
                                const abstain = parseInt(abstainInputs[index].value) || 0;
                                const total = approve + reject + abstain;
                                document.getElementById('total-' + index).textContent = total;
                            }
                            
                            approveInputs.forEach(function(input, index) {
                                input.addEventListener('input', function() { updateTotal(index); });
                                updateTotal(index);
                            });
                            
                            rejectInputs.forEach(function(input, index) {
                                input.addEventListener('input', function() { updateTotal(index); });
                                updateTotal(index);
                            });
                            
                            abstainInputs.forEach(function(input, index) {
                                input.addEventListener('input', function() { updateTotal(index); });
                                updateTotal(index);
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
