{% extends "_base.html" %}
{% load i18n %}

{% block title %}
    {% trans "Record Party Votes" %} - {{ motion.title }}
{% endblock title %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-check2-square"></i> {% trans "Record Party Votes" %}
            </h1>
            <p class="text-muted">{{ motion.title }}</p>
            {% if term %}
                <p class="text-muted small">{% trans "Term" %}: {{ term.name }}</p>
            {% endif %}
        </div>
        <div>
            <a href="{% url 'motion:motion-detail' motion.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> {% trans "Back to Motion" %}
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">{% trans "Party Voting Results" %}</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="vote-form">
                        {% csrf_token %}
                        {{ formset.management_form }}
                        
                        <!-- Vote Type Selection -->
                        <div class="mb-4">
                            <h6 class="mb-3">{% trans "Vote Type" %}</h6>
                            <div class="mb-3">
                                {% for choice in vote_type_form.vote_type %}
                                    <div class="form-check form-check-inline">
                                        {{ choice.tag }}
                                        <label class="form-check-label" for="{{ choice.id_for_label }}">
                                            {{ choice.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if vote_type_form.vote_type.errors %}
                                <div class="text-danger">
                                    {% for error in vote_type_form.vote_type.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Vote Name -->
                            <div class="mb-3">
                                <label for="{{ vote_type_form.vote_name.id_for_label }}" class="form-label">
                                    {{ vote_type_form.vote_name.label }}
                                </label>
                                {{ vote_type_form.vote_name }}
                                {% if vote_type_form.vote_name.help_text %}
                                    <small class="form-text text-muted">{{ vote_type_form.vote_name.help_text }}</small>
                                {% endif %}
                                {% if vote_type_form.vote_name.errors %}
                                    <div class="text-danger">
                                        {% for error in vote_type_form.vote_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Session Selection -->
                            <div class="mb-3">
                                <label for="{{ vote_type_form.vote_session.id_for_label }}" class="form-label">
                                    {{ vote_type_form.vote_session.label }}
                                </label>
                                {{ vote_type_form.vote_session }}
                                {% if vote_type_form.vote_session.help_text %}
                                    <small class="form-text text-muted">{{ vote_type_form.vote_session.help_text }}</small>
                                {% endif %}
                                {% if vote_type_form.vote_session.errors %}
                                    <div class="text-danger">
                                        {% for error in vote_type_form.vote_session.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Committee Selection (shown when refer_to_committee is selected) -->
                            <div id="committee-field" style="display: none;" class="mt-3">
                                <label for="{{ vote_type_form.committee.id_for_label }}" class="form-label">
                                    {{ vote_type_form.committee.label }}
                                </label>
                                {{ vote_type_form.committee }}
                                {% if vote_type_form.committee.errors %}
                                    <div class="text-danger">
                                        {% for error in vote_type_form.committee.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if formset.non_form_errors %}
                            <div class="alert alert-danger">
                                {% for error in formset.non_form_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            {% trans "Each party can vote in favor or against. Abstaining is not allowed. Votes cannot exceed the party's maximum seats for this term." %}
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 20%; text-align: center;">{% trans "Party" %}</th>
                                        <th style="width: 15%; text-align: center;">{% trans "Max Seats" %}</th>
                                        <th style="width: 18%; text-align: center;">{% trans "In Favor" %}</th>
                                        <th style="width: 18%; text-align: center;">{% trans "Against" %}</th>
                                        <th style="width: 14%; text-align: center;">{% trans "Total" %}</th>
                                        <th style="width: 15%; text-align: center;">{% trans "Notes" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in forms_with_data %}
                                        {% with form=item.form party_info=item.party_info %}
                                        <tr>
                                            <td class="align-middle">
                                                {{ form.party }}
                                                {% if party_info %}
                                                <div class="fw-bold" style="color: {{ party_info.party.color }};">
                                                    {{ party_info.party.name }}
                                                </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center align-middle">
                                                {% if party_info %}
                                                <span class="badge bg-secondary">{{ party_info.max_seats }}</span>
                                                {% else %}
                                                <span class="badge bg-secondary">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {{ form.approve_votes }}
                                                {% if form.errors and form.approve_votes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.approve_votes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {{ form.reject_votes }}
                                                {% if form.errors and form.reject_votes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.reject_votes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center align-middle">
                                                <div class="form-control-plaintext text-center fw-bold" id="total-{{ forloop.counter0 }}">
                                                    0
                                                </div>
                                            </td>
                                            <td>
                                                {{ form.notes }}
                                                {% if form.errors and form.notes.errors %}
                                                    <div class="text-danger">
                                                        {% for error in form.notes.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {% trans "Record All Votes" %}
                            </button>
                            <a href="{% url 'motion:motion-detail' motion.pk %}" class="btn btn-outline-secondary">
                                {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                    
                    <script>
                        // Calculate totals for each party and validate against max seats
                        document.addEventListener('DOMContentLoaded', function() {
                            const approveInputs = document.querySelectorAll('input[name*="approve_votes"]');
                            const rejectInputs = document.querySelectorAll('input[name*="reject_votes"]');
                            const voteTypeRadios = document.querySelectorAll('input[name="vote_type"]');
                            const committeeField = document.getElementById('committee-field');
                            const committeeSelect = document.getElementById('id_committee');
                            
                            // Show/hide committee field based on vote type
                            function toggleCommitteeField() {
                                const selectedType = document.querySelector('input[name="vote_type"]:checked');
                                if (selectedType && selectedType.value === 'refer_to_committee') {
                                    committeeField.style.display = 'block';
                                    if (committeeSelect) {
                                        committeeSelect.required = true;
                                    }
                                } else {
                                    committeeField.style.display = 'none';
                                    if (committeeSelect) {
                                        committeeSelect.required = false;
                                        committeeSelect.value = '';
                                    }
                                }
                            }
                            
                            voteTypeRadios.forEach(function(radio) {
                                radio.addEventListener('change', toggleCommitteeField);
                            });
                            toggleCommitteeField(); // Initial check
                            
                            function updateTotal(index) {
                                const row = approveInputs[index].closest('tr');
                                const maxSeatsBadge = row.querySelector('.badge');
                                const maxSeats = parseInt(maxSeatsBadge.textContent) || 0;
                                
                                const approve = parseInt(approveInputs[index].value) || 0;
                                const reject = parseInt(rejectInputs[index].value) || 0;
                                const total = approve + reject;
                                
                                const totalElement = document.getElementById('total-' + index);
                                totalElement.textContent = total;
                                
                                // Highlight if exceeds max seats
                                if (total > maxSeats) {
                                    totalElement.classList.add('text-danger');
                                    totalElement.classList.remove('text-success');
                                } else if (total > 0) {
                                    totalElement.classList.remove('text-danger');
                                    totalElement.classList.add('text-success');
                                } else {
                                    totalElement.classList.remove('text-danger', 'text-success');
                                }
                                
                                // Set max attribute on inputs
                                approveInputs[index].setAttribute('max', maxSeats);
                                rejectInputs[index].setAttribute('max', maxSeats);
                            }
                            
                            approveInputs.forEach(function(input, index) {
                                input.addEventListener('input', function() { updateTotal(index); });
                                updateTotal(index);
                            });
                            
                            rejectInputs.forEach(function(input, index) {
                                input.addEventListener('input', function() { updateTotal(index); });
                                updateTotal(index);
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
