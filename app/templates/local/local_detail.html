{% extends "_base.html" %}
{% load i18n %}
{% load static %}
{% load humanize %}

{% block title %}{{ local.name }} - {% trans "Local Details" %}{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-geo-alt"></i> {{ local.name }}</h1>
                <div>
                    <a href="{% url 'local:local-edit' local.pk %}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> {% trans "Edit" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <!-- Council Section -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-building"></i> {% trans "Council" %} <a href="{% url 'local:council-detail' local.council.pk %}">{{ local.council.name }}</a></h5>
                </div>
                <div class="card-body">
                    {% if local.council %}
                        <!-- Current Term Seat Distribution -->
                        {% if current_term %}
                            <div>
                                <h6 class="mb-3">
                                    <i class="bi bi-bar-chart"></i> 
                                    {% trans "Current Term Seat Distribution" %} 
                                    <span class="badge bg-primary">{{ current_term.name }}</span>
                                </h6>
                                
                                {% if current_term_seat_distributions %}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>{% trans "Party" %}</th>
                                                            <th>{% trans "Seats" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for distribution in current_term_seat_distributions %}
                                                            <tr>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        {% if distribution.party.color %}
                                                                            <div class="me-2" style="width: 12px; height: 12px; background-color: {{ distribution.party.color }}; border-radius: 2px;"></div>
                                                                        {% endif %}
                                                                        <strong>{{ distribution.party.name }}</strong>
                                                                        {% if distribution.party.short_name %}
                                                                            <small class="text-muted ms-1">({{ distribution.party.short_name }})</small>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <span class="badge bg-primary">{{ distribution.seats }}</span>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-md-6 d-flex justify-content-center align-items-center">
                                            <div class="seat-distribution-chart" 
                                                    data-total-seats="{{ current_term.total_seats }}"
                                                    data-allocated-seats="{{ current_term.allocated_seats }}">
                                                <svg width="300" height="200" viewBox="0 0 300 200">
                                                    <!-- Hemicycle background arcs -->
                                                    <path d="M 50 150 A 100 100 0 0 1 250 150" 
                                                            fill="none" 
                                                            stroke="#e9ecef" 
                                                            stroke-width="1"/>
                                                    <path d="M 60 150 A 90 90 0 0 1 240 150" 
                                                            fill="none" 
                                                            stroke="#e9ecef" 
                                                            stroke-width="1"/>
                                                    <path d="M 70 150 A 80 80 0 0 1 230 150" 
                                                            fill="none" 
                                                            stroke="#e9ecef" 
                                                            stroke-width="1"/>
                                                    <path d="M 80 150 A 70 70 0 0 1 220 150" 
                                                            fill="none" 
                                                            stroke="#e9ecef" 
                                                            stroke-width="1"/>
                                                    <path d="M 90 150 A 60 60 0 0 1 210 150" 
                                                            fill="none" 
                                                            stroke="#e9ecef" 
                                                            stroke-width="1"/>
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center py-3">
                                        <i class="bi bi-bar-chart fs-1 text-muted"></i>
                                        <p class="text-muted mt-2">{% trans "No seat distribution configured for the current term." %}</p>
                                        <a href="{% url 'local:term-seat-distribution' current_term.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-plus-circle"></i> {% trans "Configure Seats" %}
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>{% trans "No Current Term" %}</strong>
                                    <br>
                                    <small class="text-muted">{% trans "There is no active term for the current date range." %}</small>
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-building fs-1 text-muted"></i>
                            <h6 class="mt-3">{% trans "No Council found" %}</h6>
                            <p class="text-muted">{% trans "A council should be automatically created with each local." %}</p>
                            <a href="{% url 'local:council-create' %}?local={{ local.pk }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans "Create Council" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Parties Section -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-flag"></i> {% trans "Political Parties" %}</h5>
                    <a href="{% url 'local:party-create' %}?local={{ local.pk }}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> {% trans "Add Party" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if parties %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "Name" %}</th>
                                        <th>{% trans "Short Name" %}</th>
                                        <th>{% trans "Color" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for party in parties %}
                                        <tr>
                                            <td><strong>{{ party.name }}</strong></td>
                                            <td>{{ party.short_name|default:"-" }}</td>
                                            <td>
                                                {% if party.color %}
                                                    <span class="badge" style="background-color: {{ party.color }}; color: white;">
                                                        {{ party.color }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'local:party-detail' party.pk %}" class="btn btn-sm btn-outline-info">
                                                        <i class="bi bi-eye"></i> {% trans "View" %}
                                                    </a>
                                                    <a href="{% url 'local:party-edit' party.pk %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-pencil"></i> {% trans "Edit" %}
                                                    </a>
                                                    <a href="{% url 'local:party-delete' party.pk %}" class="btn btn-sm btn-outline-danger"
                                                       onclick="return confirm('{% trans 'Are you sure you want to delete this Party?' %}')">
                                                        <i class="bi bi-trash"></i> {% trans "Delete" %}
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-flag fs-1 text-muted"></i>
                            <h6 class="mt-3">{% trans "No Parties found" %}</h6>
                            <p class="text-muted">{% trans "Create political parties to manage seat distributions in terms." %}</p>
                            <a href="{% url 'local:party-create' %}?local={{ local.pk }}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans "Create First Party" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
    <!-- Terms Section -->
        <div class="col-12 mt-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> {% trans "Political Terms" %}</h5>
                    <a href="{% url 'local:term-create' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> {% trans "Add Term" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if terms %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>{% trans "Name" %}</th>
                                        <th>{% trans "Period" %}</th>
                                        <th>{% trans "Total Seats" %}</th>
                                        <th>{% trans "Status" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for term in terms %}
                                        <tr>
                                            <td><strong>{{ term.name }}</strong></td>
                                            <td>{{ term.start_date|date:"M Y" }} - {{ term.end_date|date:"M Y" }}</td>
                                            <td>{{ term.total_seats }}</td>
                                            <td>
                                                
                                                {% if term.is_current %}
                                                    <span class="badge bg-primary">{% trans "Current" %}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'local:term-detail' term.pk %}" class="btn btn-sm btn-outline-info">
                                                        <i class="bi bi-eye"></i> {% trans "View" %}
                                                    </a>
                                                    <a href="{% url 'local:term-edit' term.pk %}" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-pencil"></i> {% trans "Edit" %}
                                                    </a>
                                                    <a href="{% url 'local:term-seat-distribution' term.pk %}" class="btn btn-sm btn-outline-warning">
                                                        <i class="bi bi-bar-chart"></i> {% trans "Seats" %}
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-calendar-event fs-1 text-muted"></i>
                            <h6 class="mt-3">{% trans "No Terms found" %}</h6>
                            <p class="text-muted">{% trans "Create a political term to manage seat distributions." %}</p>
                            <a href="{% url 'local:term-create' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {% trans "Create First Term" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get seat distribution data
    const seatDistributions = [
        {% for distribution in current_term_seat_distributions %}
            {
                partyName: '{{ distribution.party.name }}',
                seats: {{ distribution.seats }},
                color: '{{ distribution.party.color|default:"#6c757d" }}'
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const totalSeats = {{ current_term.total_seats|default:0 }};
    const allocatedSeats = {{ current_term.allocated_seats|default:0 }};
    
    if (totalSeats > 0 && seatDistributions.length > 0) {
        // D3.js Hemicycle Layout
        const margin = {top: 0, right: 0, bottom: 0, left: 0};
        const width = 300 - margin.left - margin.right;
        const height = 200 - margin.top - margin.bottom;
        
        // Clear existing content
        const chartContainer = document.querySelector('.seat-distribution-chart svg');
        chartContainer.innerHTML = '';
        
        // Create D3 SVG
        const svg = d3.select(chartContainer)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        // Optimal hemicycle parameters based on total seats
        let h;
        if (totalSeats <= 10) {
            h = { 'n': [totalSeats], 'g': 1.40, 'w': 0.25 };
        } else if (totalSeats <= 20) {
            h = { 'n': [Math.ceil(totalSeats/2), totalSeats], 'g': 1.40, 'w': 0.25 };
        } else if (totalSeats <= 40) {
            h = { 'n': [8, 11, 15, 19, 22, 26, 29, 33, 37].slice(0, Math.ceil(totalSeats/5)), 'g': 1.40, 'w': 0.25 };
        } else {
            h = { 'n': [8, 11, 15, 19, 22, 26, 29, 33, 37], 'g': 1.40, 'w': 0.25 };
        }
        
        // Adjust h.n to match total seats
        let currentTotal = 0;
        const adjustedN = [];
        for (let i = 0; i < h.n.length && currentTotal < totalSeats; i++) {
            const seatsInRow = Math.min(h.n[i], totalSeats - currentTotal);
            if (seatsInRow > 0) {
                adjustedN.push(seatsInRow);
                currentTotal += seatsInRow;
            }
        }
        h.n = adjustedN;
        
        // D3 scales
        const rmax = 1 + h.n.length * h.g * h.w;
        const xScale = d3.scale.linear()
            .domain([-1 * rmax, rmax])
            .range([0, width]);
        const yScale = d3.scale.linear()
            .domain([0, rmax])
            .range([height, 0]);
        const x0Scale = d3.scale.linear()
            .domain([0, 2 * rmax])
            .range([0, width]);
        
        // Generate seat positions using D3 algorithm
        const data = [];
        const s = [];
        
        for (let i = 0; i < h.n.length; i++) {
            s.push((Math.PI / h.w + Math.PI * i * h.g - h.n[i]) / (h.n[i] - 1));
            const ninrow = h.n[i];
            const radwidth = Math.PI / (h.n[i] + (h.n[i] - 1) * s[i]);
            const radspace = radwidth * s[i];
            const r = 1 + i * h.g * h.w;
            
            for (let j = 0; j < ninrow; j++) {
                const x = Math.cos(radwidth * (0.5 + j) + j * radspace) * r;
                const y = Math.sin(radwidth * (0.5 + j) + j * radspace) * r;
                const rot = -1 * (radwidth * (0.5 + j) + j * radspace) / Math.PI * 180 + 90;
                data.push({'x': x, 'y': y, 'rot': rot});
            }
        }
        
        // Sort data by rotation (representatives from same party together)
        data.sort(function(x, y) {
            if (x.rot < y.rot) return -1;
            if (x.rot > y.rot) return 1;
            return 0;
        });
        
        // Add colors and names to data
        let dataIndex = 0;
        seatDistributions.forEach(function(group) {
            for (let j = 0; j < group.seats; j++) {
                if (data[dataIndex]) {
                    data[dataIndex].color = group.color;
                    data[dataIndex].name = group.partyName;
                    dataIndex++;
                }
            }
        });
        
        // Create hemicycle seats
        const icons = svg.selectAll(".icon")
            .data(data)
            .enter().append("circle")
            .attr("r", x0Scale(h.w * 0.4))
            .attr("fill", function(d) { return d.color; })
            .attr("stroke", "white")
            .attr("stroke-width", 1)
            .attr("cx", function(d) { return xScale(d.x); })
            .attr("cy", function(d) { return yScale(d.y); })
            .attr("title", function(d) { return d.name; })
            .style("cursor", "pointer");
        
        // Add hover effects
        icons.on("mouseover", function(d) {
            d3.select(this).attr("r", x0Scale(h.w * 0.6));
        }).on("mouseout", function(d) {
            d3.select(this).attr("r", x0Scale(h.w * 0.4));
        });
    }
});
</script>
{% endblock content %}
